<!DOCTYPE html>
<!--
 | Weather Wizard main features.
 +-->
<html>
<head>
    <!--meta charset="windows-1252"-->
    <!--meta charset="iso-8859-1"-->
    <!--meta charset="utf-8"-->
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
    <title>Weather Wizard</title>

    <link rel="icon" type="image/ico" href="../icons/hammerhead.02.ico">

    <link rel="stylesheet" href="../css/stylesheet.css" type="text/css"/>
    <link rel="stylesheet" href="../css/white.css" type="text/css" id="theme"/>
    <link rel="stylesheet" href="../css/worldmap.02.css" type="text/css"/>
    <link rel="stylesheet" href="../css/composites.css" type="text/css"/>

    <style>
        .map-style {
            display: block;
            height: 400px; /* Overridden onload */
            width: 850px;
            resize: both; /* Resize! */
            overflow-x: auto;
            overflow-y: auto;
            text-align: center;
        }

        canvas#mapCanvas {
            /* cursor: crosshair; */
            cursor: url('../images/crosshair.png') 19 20, auto;
        }

        .control-style {
            min-width: 350px; 
            min-height: 400px; 
            resize: both; 
            overflow-x: scroll; 
            overflow-y: scroll;
        }

        .table-style {
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #CCC;
            margin-top: 10px;
        }

        .complist-style {
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            height: 100px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #CCC;
            margin-top: 10px;
        }

        button {
            border-radius: 5px;
        }

        table.bordered th, table.bordered td {
            /*border-collapse: collapse;*/
            border: 1px solid silver;
            border-radius: 3px;
        }

        .mess-zone {
            background-color: white; 
            color: black; 
            font-family: 'Courier New', 'Source Code Pro', Helvetica, Geneva; 
            padding: 1px; border-radius: 5px; 
            border: 1px solid #CCC; 
            height: 100px; 
            max-width: 800px;
            overflow-y: scroll;
            overflow-x: scroll;
        }

        .analogdisplay-monochrome-orange {
            --bg-color: rgba(0, 0, 0, 0);
            --digit-color: orange;
            --with-gradient: false;
            --display-background-gradient-from: undefined; /* used if --withGradient: true */
            --display-background-gradient-to: rgba(0, 0, 0, 0);
            --display-line-color: rgba(255, 165, 0, 0.5); /* orange */
            --label-fill-color: rgba(255, 255, 255, 0);
            --with-display-shadow: false;
            --shadow-color: black;
            --outline-color: orange;
            --major-tick-color: orange;
            --minor-tick-color: orange;
            --value-color: orange;
            --value-outline-color: orange;
            --value-nb-decimal: 1;
            --hand-color: rgba(0, 0, 0, 0);
            --hand-outline-color: orange;
            --with-hand-shadow: false;
            --knob-color: orange;
            --knob-outline-color: orange;
            --outlined-port-starboard: true;
            --font: Arial;
            --value-font-size-factor: 1
        }

        analog-display .analog-for-prmsl {
            /* Default is 1 */
            --value-font-size-factor: 0.75
        }

        direction-display .analog-for-dir {
            --value-nb-decimal: 0;
        }

        .thermometer-orange {
            --bg-color: transparent;
            --digit-color: orange;
            --with-gradient: false;
            --display-background-gradient-to: rgba(255, 255, 255, 0.25);
            --with-display-shadow: false;
            --major-tick-color: LightGrey;
            --minor-tick-color: LightGrey;
            --value-color: orange;
            --value-outline-color: transparent;
            --value-nb-decimal: 2;
            --font: 'Arial'; /* 'Source Code Pro' */
        }

        .pluviometer-orange {
            --with-shadow: false;
            --scale-color: orange;
            --bg-color: transparent;
            --major-tick-color: orange;
            --minor-tick-color: orange;
            --value-outline-color: orange;
            --value-color: orange;
            --tube-outline-color: orange;
            --rain-outline-color: orange;
            --inside-tube-from: transparent;
            --inside-tube-to: transparent;
            --font: 'Arial'
        }

        .beaufort-01 {
            --bg-color: transparent;
            --with-gradient: false;
            --display-background-gradient-from: black;
            --display-background-gradient-to: red;
            --with-display-shadow: true;
            --shadow-color: rgba(0, 0, 0, 0.75);
            --outline-color: white;
            --value-color: orange;
            --value-outline-color: black;
            --value-nb-decimal: 1;
            --font: Arial;
        }


    </style>

    <script type="text/javascript" src="../widgets/WorldMapData.js"></script>
    <script type="text/javascript" src="../js/mercator.utils.js"></script>
    <script type="text/javascript" src="../widgets/worldmap.js"></script>
    <script type="text/javascript" src="../js/conversion.utils.js"></script>
    <script type="text/javascript" src="../js/date.proto.js"></script>
    <script type="text/javascript" src="../js/routes.utils.js"></script>
    <script type="text/javascript" src="../js/grib.routing.js"></script>
    <!--script type="text/javascript" src="../catalog/catalog.js"></script--> <!-- Composites catalog --> 
    <script type="text/javascript" src="../js/ww.js"></script>

    <!-- WebComponents -->
    <script type="module" src="../webcomponents/Pluviometer.js"></script>
    <script type="module" src="../webcomponents/Thermometer.js"></script>
    <script type="module" src="../webcomponents/DirectionDisplay.js"></script>
    <script type="module" src="../webcomponents/AnalogDisplay.js"></script>
    <script type="module" src="../webcomponents/Beaufort.js"></script>


    <!-- Minimized versions, generated by ../gradlew minifyJS and ../gradlew minifyWidgets -->
    <!--script type="text/javascript" src="../minjs/jquery-2.1.3.js"></script>
    <script type="text/javascript" src="../minjs/WorldMapData.js"></script>
    <script type="text/javascript" src="../minjs/mercator.utils.js"></script>
    <script type="text/javascript" src="../minjs/worldmap.js"></script>
    <script type="text/javascript" src="../minjs/conversion.utils.js"></script>
    <script type="text/javascript" src="../minjs/date.proto.js"></script>
    <script type="text/javascript" src="../minjs/routes.utils.js"></script>
    <script type="text/javascript" src="../minjs/grib.routing.js"></script>
    <script type="text/javascript" src="../catalog/catalog.js"></script>
    <script type="text/javascript" src="../minjs/ww.js"></script-->

    <script type="text/javascript">

        if (typeof(decToSex) !== 'function') {
            let decToSex = (val, ns_ew) => {
                let absVal = Math.abs(val);
                let intValue = Math.floor(absVal);
                let dec = absVal - intValue;
                let i = intValue;
                dec *= 60;
                let s = i + "&deg;" + dec.toFixed(2) + "'";

                if (val < 0) {
                    s += (ns_ew === 'NS' ? 'S' : 'W');
                } else {
                    s += (ns_ew === 'NS' ? 'N' : 'E');
                }
                return s;
            };
        }

        let flavor = 'Ajax'; // Default, WebSocket not implemented here (we run on a small http server).
    
        let currentFax = 1;
        let canvas, context;
    
        let thisZoomFactor = 1;
    
        let messageManager = (mess) => {
            let messZone = document.getElementById("message-zone");
            if (messZone) {
                let existingContent = messZone.innerHTML;
                if (existingContent.trim().length > 0) {
                    existingContent += "\n";
                }
                existingContent = existingContent.replace("<pre>", "");
                existingContent = existingContent.replace("</pre>", "");
                existingContent += (typeof(mess) === 'object' ? JSON.stringify(mess, null, 2) : mess);
                messZone.innerHTML = "<pre>" + existingContent + "</pre>";
                // Scroll at the bottom
                messZone.scrollTop = messZone.scrollHeight;
            } else {
                console.log(mess);
            }
        }
    
        let clearMessZone = () => {
            let messZone = document.getElementById("message-zone");
            messZone.innerText = '';
        }
    
        let mouseClickCallback = (obj) => {
            let lat = obj.lat;
            let lng = obj.lng;
            messageManager(`Mouse clicked on the Map ${lat} / ${lng}.`);
            // console.log("Mouse clicked on the map", obj);

            if (document.getElementById('rb-going-to').checked) {
                document.getElementById('routing-pos-lat-sign-01').value = (lat < 0 ? "S" : "N");
                document.getElementById('routing-pos-lng-sign-01').value = (lng < 0 ? "W" : "E");
                lat = Math.abs(lat);
                lng = Math.abs(lng);
                document.getElementById('routing-pos-lat-deg-01').value = Math.floor(lat).toFixed(0);
                document.getElementById('routing-pos-lng-deg-01').value = Math.floor(lng).toFixed(0);
    
                document.getElementById('routing-pos-lat-min-01').value = ((lat - Math.floor(lat)) * 60).toFixed(2);
                document.getElementById('routing-pos-lng-min-01').value = ((lng - Math.floor(lng)) * 60).toFixed(2);
            } else {
                position.lat = obj.lat;
                position.lng = obj.lng;
                worldMap.setUserPosition({latitude: position.lat, longitude: position.lng});
                redraw();
            }
        };
    
        let mouseMoveCallback = (obj) => {
            //  Display position, GRIB Data, etc...
            let mouseDataElmt = document.getElementById("mouse-data");
            let str = "Mouse X: " + obj.x + ", Y:" + obj.y;
            str += ("\nL: " + decToSex(obj.lat, "NS"));
            str += ("\nG: " + decToSex(obj.lng, "EW"));

            document.getElementById('mouse-pos').innerText = `${decToSex(obj.lat, "NS")} / ${decToSex(obj.lng, "EW")}`;
    
            if (gribData !== undefined) {
                let date = document.getElementById("grib-dates").value;
                let oneDateGRIB = gribData[0]; // Default
                // Look for the right date
                for (let i = 0; i < gribData.length; i++) {
                    if (gribData[i].gribDate.formattedUTCDate === date) {
                        oneDateGRIB = gribData[i];
                        break;
                    }
                }
                // The current frame is oneDateGRIB
                // Find the GRIB Cell
                let xCell = oneDateGRIB.gribDate.width - 1,
                    yCell = oneDateGRIB.gribDate.height - 1;
    
                // console.log("  > xCell %d", xCell);
    
                for (let hGRIB = 0; hGRIB < oneDateGRIB.gribDate.height; hGRIB++) {
                    let lat = oneDateGRIB.gribDate.bottom + ((oneDateGRIB.gribDate.stepy * hGRIB));
                    if (lat > obj.lat) {
                        yCell = (hGRIB - 1);
                        break;
                    }
                }
    
                for (let wGRIB = 0; wGRIB < oneDateGRIB.gribDate.width; wGRIB++) {
                    let lng = ajustedLongitude(oneDateGRIB.gribDate.left, (oneDateGRIB.gribDate.stepx * wGRIB));
                    if (lng > 0 && obj.lng > 0 && lng > obj.lng) {
                        xCell = wGRIB - 1;
                        break;
                    } else if (lng < 0 && obj.lng < 0 && obj.lng < lng) {
                        xCell = wGRIB - 1;
                        break;
                    }
                }
                // console.log("  >> %s / %s is in cell Row:%d, Col:%d (Total is %d rows, %d cols)",
                // 		decToSex(obj.lat, "NS"),
                // 		decToSex(obj.lng, "EW"),
                // 		yCell,
                // 		xCell,
                // 		oneDateGRIB.gribDate.height,
                // 		oneDateGRIB.gribDate.width);
    
                str += ("\nGRIB cell row <b>" + yCell + "</b>, col <b>" + xCell + "</b>");
                let foundWind = false;
                for (let idx = 0; idx < oneDateGRIB.typedData.length; idx++) {
                    let skip = false;
                    if (oneDateGRIB.typedData[idx].data[yCell] === undefined) {
                        console.debug(">>>> oneDateGRIB.typedData[idx].data, yCell:%d, undefined.", yCell);
                        break;
                    }
                    let value = oneDateGRIB.typedData[idx].data[yCell][xCell]; // TODO xCell === -1
                    let unit = oneDateGRIB.typedData[idx].gribType.unit;
                    let type = oneDateGRIB.typedData[idx].gribType.type;
    
                    // console.log("  >>> Type: %s, xCell: %d", type, xCell);
    
                    let displayValue = '-', displayUnit = '-', displayType = '-';
                    if (value !== undefined) {  // xCell === -1 ?
                        switch (type) {
                            case 'prmsl':
                                displayType = 'PRMSL';
                                displayValue = (value / 100).toFixed(2);
                                displayUnit = 'hPa';
                                // Web Component
                                document.getElementById('prmsl-01').value = displayValue;
                                break;
                            case 'tmp':
                                displayType = 'AIRTMP';
                                displayValue = (value - 273.6).toFixed(2);
                                displayUnit = 'C';
                                // Web Component
                                document.getElementById('thermometer-01').value = displayValue;
                                break;
                            case 'ugrd':
                                if (!foundWind) {
                                    let vgrd;
                                    for (let i = 0; i < oneDateGRIB.typedData.length; i++) {
                                        if (oneDateGRIB.typedData[i].gribType.type === 'vgrd') {
                                            vgrd = oneDateGRIB.typedData[i].data;
                                            break;
                                        }
                                    }
                                    if (vgrd !== undefined) {
                                        displayUnit = '';
                                        displayType = "WIND";
                                        let u = value;
                                        let v = vgrd[yCell][xCell];
                                        let tws = getSpeed(u, v);
                                        let dir = getDir(u, v);
                                        displayValue = tws.toFixed(1) + " kts, " + dir.toFixed(0) + "&deg; (u:" + u.toFixed(1) + ", v:" + v.toFixed(1) + "), Cell <b>" + yCell + "</b>, <b>" + xCell + "</b>.";
                                        // Update Web Components
                                        document.getElementById('tws-01').value = tws;
                                        document.getElementById('beaufort-01').value = tws;
                                        document.getElementById('twd-01').value = dir.toFixed(0);
                                        // console.log('w:%d, h:%d', yCell, xCell);
                                        foundWind = true;
                                    }
                                } else {
                                    skip = true;
                                }
                                break;
                            case 'vgrd':
                                skip = true;
                                break;
                            case 'prate':
                                displayType = 'PRATE';
                                displayValue = (value * 3600).toFixed(2);
                                displayUnit = "mm/h";
                                // Web Component
                                document.getElementById('rain-01').value = displayValue;
                                break;
                            case 'hgt':
                                displayType = '500HGT';
                                try {
                                    displayValue = (value).toFixed(2);
                                    displayUnit = "m";
                                } catch (err) {
                                    displayValue = "xx";
                                    displayUnit = "-";
                                    // console.log(err);
                                    messageManager(JSON.stringify(err, null, 2));
                                }
                                break;
                            case 'htsgw':
                                displayType = 'WAVES';
                                if (oneDateGRIB.typedData[idx].data[0].length !== oneDateGRIB.gribDate.width) {
                                    // Re-adjust. Waves do not have the same grid size...
                                    let _xCell = Math.floor(xCell * oneDateGRIB.typedData[idx].data[0].length / oneDateGRIB.gribDate.width);
                                    value = oneDateGRIB.typedData[idx].data[yCell][_xCell];
                                }
                                try {
                                    displayValue = value.toFixed(2);
                                    displayUnit = unit;
                                } catch (err) {
                                    displayValue = "xx";
                                    displayUnit = "-";
                                    // console.log(err);
                                    messageManager(err);
                                }
                                break;
                            default:
                                break;
                        }
                    } else {
                        skip = true;
                    }
                    if (!skip) {
                        str += ("\n" + displayType + ": " + displayValue + " " + displayUnit);
                    }
                }
            }
            mouseDataElmt.innerHTML = ("<pre>" + str + "</pre>");
        };
    
        let displayErr = (err) => {
            if (err !== undefined) {
                document.getElementById("err-mess").innerHTML = ("<small>" + err + "</small>");
            }
        };
    
        let withChart = true;
    
        let changeChart = (cb) => {
            withChart = cb.checked;
            redraw();
        };
    
        let changeGrid = (cb) => {
            worldMap.setWithGrid(cb.checked);
            redraw();
        };
    
        let changeTropics = (cb) => {
            worldMap.setWithTropics(cb.checked);
            redraw();
        };
    
        let changeGRIB = (cb) => {
            worldMap.setAfterDrawing(cb.checked ? renderGRIBData : undefined);
            redraw();
        };
    
        // changeFAXES
        let changeFAXES = (cb) => {
            // worldMap.setAfterDrawing(cb.checked ? renderGRIBData : undefined);
            for (let sh = 0; sh < show.length; sh++) {
                if (cb.checked === false) {
                    show[sh] = false;
                } else { // See the status of the corresponding Fax CB
                    show[sh] = cb.checked;
                    // Check all the checkboxes in table with id 'fax-table'
                    let faxTable = document.getElementById('fax-table');
                    let cbs = faxTable.querySelectorAll('input[type=checkbox]');
                    if (cbs !== undefined && cbs !== null) {
                        show[sh] = cbs[sh].checked;
                    }
                }
            }
            redraw();
        };
    
        let show = []; // [true, true, true];
        let faxName = [];
        // For 3 faxes Sfc, 500mb, StreamLines
        let zoom = []; // [0.3418498710866215, 0.5209310701416114, 1.0040821009550305];
        let topLeft = [];
        //  [
        //	  [10, 10],
        //	  [15, 30],
        //	  [-41, 460]
        //  ];
        let faxObj = [];
    
        let faxRequestCallback = (val, originalRequest) => {
            let returned = (typeof(val) === 'string') ? JSON.parse(val) : val;
    
            // get data from originalRequest
            show = [];
            zoom = [];
            topLeft = [];
            faxObj = [];
            faxName = [];
            for (let idx = 0; idx < originalRequest.faxData.length; idx++) {
                show.push(true);
    
                let fax = new Image();
                let x = originalRequest.faxData[idx].location.x;
                let y = originalRequest.faxData[idx].location.y;
                let faxZoom = originalRequest.faxData[idx].zoom;
                zoom.push(faxZoom);
                topLeft.push([x, y]);
                faxName.push(originalRequest.faxData[idx].name);
                fax.onload = () => {
                    context.drawImage(fax, x, y, (parseInt(fax.width) * faxZoom), (parseInt(fax.height) * faxZoom));
                    redraw();
                };
                // Assume that returned and originalRequest have the same cardinality
                if (returned[idx].returned !== undefined) {
                    if (returned[idx].returned.startsWith("file:")) { // && returned[idx].returned.indexOf("/web/") > -1) {
                        // TODO Something better, relative to /web
                        let loc = returned[idx].returned.substring(returned[idx].returned.indexOf("/web/") + 1);
                        fax.src = '../../' + loc;
                    } else {
                        fax.src = '../../' + returned[idx].returned;
                    }
                }
                speakUp(idx + 1);
                // console.log(fax.src);
                messageManager(fax.src);
                faxObj.push(fax);
            }
        };
    
        let findCompositeByKey = (key) => {
            let comp = {};
            for (let i = 0; i < compositeCatalog.length; i++) {
                if (key === compositeCatalog[i].key) {
                    comp = compositeCatalog[i];
                    break;
                }
            }
            return comp;
        };
    
        const monthNames = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];
    
        /*
         * Reload an existing composite.
         */
        let reload = (key, compositeData) => {
            console.log("Reloading", key, compositeData);
            composeCompositeInfo(key);
            let originalComposite = findCompositeByKey(key);

            let composite = JSON.parse(JSON.stringify(originalComposite));  // This is a deep copy, not to modify the catalog

            // Fill out with actual file locations  
            if (composite.faxData !== undefined) {
                for (let i = 0; i < composite.faxData.length; i++) {
                    for (let f = 0; f < compositeData.length; f++) {
                        if (compositeData[f].type === 'FAX' &&
                            compositeData[f].name === '_' + key + '_' + i + '.png') {
                            composite.faxData[i].faxUrl = compositeData[f].resource; 
                            break;
                        }
                    }
                }
                // GRIB
                if (composite.gribRequest !== undefined) {
                    for (let f = 0; f < compositeData.length; f++) {
                        if (compositeData[f].type === 'GRIB') { // name='grib.grb'
                            composite.gribRequest = compositeData[f].resource; 
                            break;
                        }
                    }
                }
            }
            loadComposite(composite);
        };
    
        let getKeyFromName = (name) => {
            let key = name.substring(0, name.indexOf('_'));
            return key;
        };
    
        let readableName = (name) => {
            let key = getKeyFromName(name);
            let time = name.substring(name.indexOf('_') + 1);
            let hours = time.substring(0, 2);
            let min = time.substring(2, 4);
            let sec = time.substring(4);
    
            let comp = findCompositeByKey(key);
            let desc = comp.name;
    
            return (key + " @ " + hours + ":" + min + ":" + sec + (desc !== undefined ? "<br><small>" + desc + "</small>" : ""));
        };
    
        let expandCollapse = (id) => {
            // 	console.log('>> Exp/Coll ' + id);
            let elmt = document.getElementById(id);
            if (elmt.style.display === "none") {
                elmt.style.display = "block";
            } else {
                elmt.style.display = "none";
            }
        };
    
        /*
            Sample data:
    
            {
            "2017": {
                "12": {
                    "10": [
                        {
                            "name": "ATL-0001_184206",
                            "compositeElements": [
                                {
                                    "type": "FAX",
                                    "name": "_ATL-0001_0.png",
                                    "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/_ATL-0001_0.png"
                                },
                                {
                                    "type": "FAX",
                                    "name": "_ATL-0001_1.png",
                                    "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/_ATL-0001_1.png"
                                },
                                {
                                    "type": "GRIB",
                                    "name": "grib.grb",
                                    "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/grib.grb"
                                }
                            ]
                        },
                        {
                            "name": "PAC-0001_073637",
                            "compositeElements": [
                                {
                        ...
    
            */
    
        let sortObject = (o) => { // Sort by property of level 1
            let sorted = {},
                key, a = [];
    
            for (key in o) {
                if (o.hasOwnProperty(key)) {
                    a.push(key);
                }
            }
    
            a.sort();
    
            for (key = 0; key < a.length; key++) {
                sorted[a[key]] = o[a[key]];
            }
            return sorted;
        };
    
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
        let makeCompositeTree = (tree) => {
            let htmlCode = "<b>Existing Composites:</b><ul style='margin-left: -20px;'>";
            for (let year in tree) {
                htmlCode += "<li type='disc'>";
                htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "\");' style='cursor: pointer;'>");
                let months = tree[year];
                let nbMonths = Object.keys(months).length;
                htmlCode += (year + " (" + nbMonths + " month" + (nbMonths > 1 ? "s" : "") + ") :");
                htmlCode += ("</span>");
                htmlCode += ("<ul id='" + year + "' style='display: none; padding-left: 10px;'>");
                for (let month in months) {
                    htmlCode += "<li type='disc'>";
                    htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "-" + month + "\");' style='cursor: pointer;'>");
                    let days = sortObject(months[month]);
                    let nbDays = Object.keys(days).length;
                    htmlCode += (monthNames[parseInt(month) - 1] + " (" + nbDays + " day" + (nbDays > 1 ? "s" : "") + ") :");
                    htmlCode += ("</span>");
                    htmlCode += ("<ul id='" + year + "-" + month + "' style='display: none; padding-left: 10px;'>");
    
                    let sortedDays = Object.keys(days);
                    sortedDays.sort();
                    for (let x = 0; x < sortedDays.length; x++) {
                        let day = sortedDays[x]; // day number as a String
                        // Find week day
                        let date = new Date(year, month - 1, day);
                        let weekDay = date.getDay();
                        htmlCode += "<li type='disc'>";
                        htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "-" + month + "-" + day + "\");' style='cursor: pointer;'>");
                        let compositeList = days[day]; // Array
                        htmlCode += (day + ", " + dayNames[weekDay] + " (" + compositeList.length + " composite" + (compositeList.length > 1 ? "s" : "") + ") :");
                        htmlCode += ("</span>");
                        htmlCode += ("<ul id='" + year + "-" + month + "-" + day + "' style='display: none; padding-left: 10px;'>");
                        for (let i = 0; i < compositeList.length; i++) {
                            let comp = compositeList[i];
                            htmlCode += ("<li type='disc'><a class='compositeNode' onclick='reload(\"" + getKeyFromName(comp.name) + "\", " + JSON.stringify(comp.compositeElements) + ");'>" + readableName(comp.name) + "</a></li>"); // The leaf!
                        }
                        htmlCode += "</ul>";
                        htmlCode += "</li>";
                    }
                    htmlCode += "</ul>";
                    htmlCode += "</li>";
                }
                htmlCode += "</ul>";
                htmlCode += "</li>";
            }
            htmlCode += "</ul>";
            return htmlCode;
        };
    
        let getCompositeList = () => {
            let filter = document.getElementById("comp-name-filter").value;
    //  console.log("Filtering: " + filter);
            let cb = (value) => {
    //		console.log(value);
                let data = (typeof(value) === 'string') ? JSON.parse(value) : value;
                document.getElementById("composite-list").innerHTML = (makeCompositeTree(data)); // "<pre>" + JSON.stringify(data, null, 2) + "</pre>");
            };
            getExistingComposites(cb, filter);
        };
    
        let displaySummary = (bestRoute) => {
            bestRoute.waypoints.forEach(wp => {
                console.log("At", wp.datetime, "Position", wp.position.latitude, wp.position.longitude);
                console.log("  TWS", wp.tws, "TWD", wp.twd, "BSP", wp.bsp, "HDG", wp.hdg);
            });
        };
    
        const DURATION_FMT = "Y-m-dTH:i:s";
        const ROUTING_VERBOSE = true;
    
        let testRouting = () => {
    
            console.log('GRIB Data:', gribFileLocation); // Use this one?
    
            if (gribFileLocation === undefined) {
                alert("No GRIB File location, aborting");
                return;
            }
            let toL = (document.getElementById('routing-pos-lat-sign-01').value === 'S' ? -1 : 1) * (parseInt(document.getElementById('routing-pos-lat-deg-01').value) +
                (parseFloat(parseInt(document.getElementById('routing-pos-lat-min-01').value) / 60)));
            let toG = (document.getElementById('routing-pos-lng-sign-01').value === 'W' ? -1 : 1) * (parseInt(document.getElementById('routing-pos-lng-deg-01').value) +
                (parseFloat(parseInt(document.getElementById('routing-pos-lng-min-01').value) / 60)));
            let now = new Date();
            let utc = new Date(now.getTime() + (now.getTimezoneOffset() * 60 * 1000)).format(DURATION_FMT);
            let sampleRequest = {
                "fromL": position.lat,
                "fromG": position.lng,
                "toL": toL,
                "toG": toG,
                "startTime": utc,
                "gribName": gribFileLocation + "/grib.grb",
                "polarFile": "./sample.data/polars/CheoyLee42.polar-coeff",
                "outputType": "JSON",
                "timeInterval": 24,    // Watch the OutOfMemoryError...
                "routingForkWidth": 140,
                "routingStep": 10,
                "limitTWS": -1,
                "limitTWA": -1,
                "speedCoeff": 0.75,
                "proximity": 25,
                "avoidLand": false,
                "verbose": false
            };
            let callback = (bestRoute) => {
                // bestRouteToPlot is declared in gbrib.routing.js
                bestRouteToPlot = (typeof(bestRoute) === 'string') ? JSON.parse(bestRoute) : bestRoute; // in grib.routing.js, global.
                if (ROUTING_VERBOSE) {
                    console.log(`Routing has ${ bestRouteToPlot.waypoints.length } point(s)`);
                    console.log(bestRoute);
                }
                if (ROUTING_VERBOSE) {
                    displaySummary(bestRouteToPlot);
                }
                plotBestRoute(canvas, context);
            };
            getBestRoute(sampleRequest, callback);
        };
    
        let compositeInterval;
        let timerInterval;
        let timeToNextLoad = 0;
    
        let intervalInSeconds = 3600 * 6;
    
        let secToHMS = (nbSec) => {
            let h = Math.floor(nbSec / 3600);
            let m = Math.floor((nbSec - (h * 3600)) / 60);
            let s = nbSec % 60;
    
            let strH = h.toFixed(0);
            while (strH.length < 2) {
                strH = '0' + strH;
            }
            let strM = m.toFixed(0);
            while (strM.length < 2) {
                strM = '0' + strM;
            }
            let strS = s.toFixed(0);
            while (strS.length < 2) {
                strS = '0' + strS;
            }
            return strH + ":" + strM + ":" + strS;
        };
    
        let continuousLoad = (cb) => {
            if (cb.checked === true) { // Start
                timeToNextLoad = intervalInSeconds; // In seconds
                document.getElementById("load-composites").disabled = true;
                compositeInterval = setInterval(() => {
                    loadComposite();
                    timeToNextLoad = intervalInSeconds; // In seconds
                }, 1000 * intervalInSeconds); // Every 6 hours
                timerInterval = setInterval(() => {
                        timeToNextLoad -= 1; // Decrease
                        let strTime = secToHMS(timeToNextLoad);
                        document.getElementById("time-to-next").innerText = (" (in " + strTime + ")");
                    },
                    1000); // Every second
            } else { // Stop
                document.getElementById("load-composites").disabled = false;
                clearInterval(compositeInterval);
                clearInterval(timerInterval);
                document.getElementById("time-to-next").innerText = ("");
            }
        };
    
        /**
         * If existing data is provided, it comes from the file system.
         * Otherwise, get it from the web.
         */
        let loadComposite = (existingData) => {
            document.getElementById("grib-widgets").style.display = 'none';
            document.getElementById("grib-web-comps").style.display = 'none';
            let key = document.getElementById('composites').value;
    
            let compositeData = (existingData === undefined ? findCompositeByKey(key) : existingData);
    
            // Clear previous one if any
            gribData = undefined;
    
            gribFileLocation = undefined;
            if (existingData !== undefined && existingData.gribRequest !== undefined) {
                gribFileLocation = existingData.gribRequest;
                if (gribFileLocation.endsWith("grib.grb")) {
                    gribFileLocation = gribFileLocation.substring(0, gribFileLocation.length - "grib.grb".length);
                }
                if (gribFileLocation.startsWith("file:")) {
                    gribFileLocation = gribFileLocation.substring("file:".length);
                }
                document.getElementById('current-grib-location').innerText = ('GRIB in ' + gribFileLocation);
            }
    
            errManager = (mess) => { // Override the one in ww.js. Console, and TextArea
                console.log(mess);
                messageManager(mess);
            };
    
            // console.log("Loading", (typeof(compositeData) === 'object' ? JSON.stringify(compositeData, null, 2) : compositeData));
            messageManager("--- Loading: ---");
            messageManager(compositeData);
            messageManager("----------------");

            worldMap.setCanvasWidth(compositeData.canvas.w);
            worldMap.setCanvasHeight(compositeData.canvas.h);
            worldMap.setNorth(compositeData.map.north);
            worldMap.setSouth(compositeData.map.south);
            worldMap.setWest(compositeData.map.west);
            worldMap.setEast(compositeData.map.east); // Recalculated, anyway.
            worldMap.setProjection(compositeData.map.projection);
    
            worldMap.drawWorldMap();
            document.getElementById("grib-checkbox").disabled = true;
            document.getElementById("grib-checkbox").checked = false;

            // document.getElementById("grib-widgets").style.display = 'block';
            // document.getElementById("grib-web-comps").style.display = 'block';
    
            // $("#fax-checkbox").prop("disabled", true);
            // $("#fax-checkbox").prop("checked", false);
    
            // Clean up dynamic data
            // 1 - Fax Table rows
            let idx = 1;
            let go = true;
            while (go) {
                let row = document.getElementById('row-' + idx);
                if (row !== null) {
                    row.parentNode.removeChild(row);
                    idx += 1;
                } else {
                    go = false;
                }
            }
            // 2 - Fax zooms
            idx = 1;
            go = true;
            while (go) {
                let radio = document.getElementById('zoomfor-' + idx);
                if (radio !== null) {
                    radio.parentNode.removeChild(radio);
                    idx += 1;
                } else {
                    go = false;
                }
            }
    
            let year, month, day, time;
            let now = new Date();
            year = now.format('Y');
            month = now.format('m');
            day = now.format('d');
            time = compositeData.key + '_' + now.format('His');
    
            let requestData = [];
            if (compositeData.faxData !== undefined) {
    
                compositeData.faxData.forEach((fax, idx) => {
                    let oneFax = {
                        url: fax.faxUrl,
                        name: fax.name,
                        storage: 'web/' + year + '/' + month + '/' + day + '/' + time + '/' + compositeData.key + '_' + idx + '.png', // Original. With the date
                        returned: 'web/' + year + '/' + month + '/' + day + '/' + time + '/_' + compositeData.key + '_' + idx + '.png', // Transformed
                        transparent: fax.transp,
                        imgType: "png",
                        tx: fax.effect
                    };
                    if (fax.tx !== undefined) {
                        oneFax.from = fax.tx.from;
                        oneFax.to = fax.tx.to;
                    }
                    if (fax.rotation !== undefined) {
                        oneFax.rotation = fax.rotation;
                    }
                    requestData.push(oneFax);
    
                    /*
                        Adding rows like
                    <tr>
                        <td>[checkbox]</td>
                                <td>1</td>
                                <td><div id="name-1"></div></td>
                        <td><div id="x-1" style="text-align: right;"></div></td>
                                <td><div id="y-1" style="text-align: right;"></div></td>
                                <td><div id="zoom-1" style="text-align: right;"></div></td>
                            </tr>
                    */
                    let faxTable = document.getElementById('fax-table');
                    let row = document.createElement('tr');
                    row.id = 'row-' + (idx + 1);
    
                    // Adding a checkbox <input type="checkbox" onchange="showHide(1, this);" checked>Show fax #1 <br/>
                    let div = document.createElement('div');
                    div.id = 'cb-' + (idx + 1);
    
                    let cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.id = 'cb-' + (idx + 1);
                    cb.setAttribute('onchange', 'showHide(' + (idx + 1) + ', this);');
                    cb.checked = true;
                    div.appendChild(cb);
                    let col0 = document.createElement('td');
                    col0.setAttribute('style', 'text-align: center;');
                    row.appendChild(col0);
                    col0.appendChild(cb);
    
                    let col1 = document.createElement('td');
                    row.appendChild(col1);
                    col1.appendChild(document.createTextNode((idx + 1)));
    
                    let col2 = document.createElement('td');
                    row.appendChild(col2);
                    let div2 = document.createElement('div');
                    div2.id = 'name-' + (idx + 1);
                    div2.style.whiteSpace = "nowrap";
                    div2.appendChild(document.createTextNode(fax.name));
                    col2.appendChild(div2);
    
                    let col3 = document.createElement('td');
                    row.appendChild(col3);
                    let div3 = document.createElement('div');
                    div3.id = 'x-' + (idx + 1);
                    div3.setAttribute('style', 'text-align: right;');
                    div3.appendChild(document.createTextNode(fax.location.x));
                    col3.appendChild(div3);
    
                    let col4 = document.createElement('td');
                    row.appendChild(col4);
                    let div4 = document.createElement('div');
                    div4.id = 'y-' + (idx + 1);
                    div4.setAttribute('style', 'text-align: right;');
                    div4.appendChild(document.createTextNode(fax.location.y));
                    col4.appendChild(div4);
    
                    let col5 = document.createElement('td');
                    row.appendChild(col5);
                    let div5 = document.createElement('div');
                    div5.id = 'zoom-' + (idx + 1);
                    div5.setAttribute('style', 'text-align: left;');
                    div5.appendChild(document.createTextNode(fax.zoom));
                    col5.appendChild(div5);
    
                    faxTable.appendChild(row);
    
                }); // end forEach
    
                // Request ready
                // console.log(requestData);
                messageManager(requestData);
                getCompositeFaxes(requestData, compositeData, faxRequestCallback);
            }
    
            if (compositeData.gribRequest !== undefined) {
                makeGRIBRequest(compositeData.gribRequest, existingData === undefined ? 'web/' + year + '/' + month + '/' + day + '/' + time : undefined); // grib file Location
            }
        };
    
        let speakUp = (num) => {
            document.getElementById("name-" + num).innerText = faxName[num - 1];
            document.getElementById("x-" + num).innerText = (topLeft[num - 1][0] * thisZoomFactor).toFixed(0);
            document.getElementById("y-" + num).innerText = (topLeft[num - 1][1] * thisZoomFactor).toFixed(0);
            document.getElementById("zoom-" + num).innerText = (zoom[num - 1] * thisZoomFactor);
        };
    
        let zoomFax = (num, factor) => {
            zoom[num - 1] *= factor;
            speakUp(num);
            redraw();
        };
    
        let zoomIn = () => {
            let factor = parseFloat(document.getElementById("zoom-factor").value);
            zoomFax(currentFax, factor);
        };
    
        let zoomOut = () => {
            let factor = parseFloat(document.getElementById("zoom-factor").value);
            zoomFax(currentFax, 1 / factor);
        };
    
        let up = () => {
            topLeft[currentFax - 1][1] -= 1;
            speakUp(currentFax);
            redraw();
        };
    
        let down = () => {
            topLeft[currentFax - 1][1] += 1;
            speakUp(currentFax);
            redraw();
        };
    
        let left = () => {
            topLeft[currentFax - 1][0] -= 1;
            speakUp(currentFax);
            redraw();
        };
    
        let right = () => {
            topLeft[currentFax - 1][0] += 1;
            speakUp(currentFax);
            redraw();
        };
    
        let showHide = (num, cb) => {
            show[num - 1] = cb.checked;
            redraw();
        };
    
        let scrollGribInterval = -1;
    
        let scrollGribs = (cb) => {
            // console.log("Yes! %s", cb.checked);
            let gribDatesList = document.getElementById("grib-dates");
            if (cb.checked) {
                scrollGribInterval = window.setInterval(() => {
                    // Move to next grib date
                    let selectedIndex = gribDatesList.options.selectedIndex;
                    selectedIndex += 1;
                    if (selectedIndex > gribDatesList.options.length - 1) {
                        selectedIndex = 0;
                    }
                    gribDatesList.options.selectedIndex = selectedIndex;
                    // Redraw
                    redraw();
                }, 2000);
            } else {
                window.clearInterval(scrollGribInterval);
            }
        }
    
        let redraw = () => {
            worldMap.clear();
    //  worldMap.setPositionLabel("");
    
            if (withChart) { // Chart (and GRIBs) *under* the faxes
                worldMap.drawWorldMap(false);
            }
    
            for (let sh = 0; sh < show.length; sh++) {
                if (show[sh] === true && faxObj[sh] !== undefined) {
                    context.drawImage(
                        faxObj[sh],
                        topLeft[sh][0] * thisZoomFactor,
                        topLeft[sh][1] * thisZoomFactor,
                        (parseInt(faxObj[sh].width) * zoom[sh]) * thisZoomFactor,
                        (parseInt(faxObj[sh].height) * zoom[sh] * thisZoomFactor)
                    );
                }
            }
    //		if (withChart) { // GRIB over the faxes
    //			worldMap.drawWorldMap(false);
    //		}
        };
    
        let changeFax = (val) => {
            currentFax = val;
        };
    
        const GRIB_DEBUG = false;
    
        let plotGrib = (jsonGrib) => {
            if (GRIB_DEBUG) { // DEBUG
                // console.log("Received GRIB");
                messageManager("Received GRIB");
                // Extract the dates
                jsonGrib.forEach((grib, idx) => {
                    // console.log('GRIB Date:', grib.gribDate.formattedUTCDate);
                    messageManager('GRIB Date:' + grib.gribDate.formattedUTCDate);
                });
    
                jsonGrib[0].typedData.forEach((type, idx) => {
                    // console.log('Type:', type.gribType.desc);
                    messageManager('Type:' + type.gribType.desc);
                });
            }
            // Enable GRIB widgets
            document.getElementById("grib-widgets").style.display = 'block';
            document.getElementById("grib-web-comps").style.display = 'inline-block';

            // Create the UI widgets to deal with the GRIB
            // 1. Dates
            let gribDates = document.getElementById("grib-dates");
            while (gribDates.options.length > 0) {
                gribDates.remove(0);
            }
    
            jsonGrib.forEach((grib, idx) => {
                let option = document.createElement("option");
                option.text = grib.gribDate.formattedUTCDate;
                option.value = grib.gribDate.formattedUTCDate;
                gribDates.add(option);
            });
            // 2. Types
            let gribTypes = document.getElementById("grib-types");
            while (gribTypes.options.length > 0) {
                gribTypes.remove(0);
            }
    
            let foundWind = false;
            jsonGrib[0].typedData.forEach((type, idx) => {
                let option = document.createElement("option");
                if (type.gribType.type === 'vgrd' || type.gribType.type === 'ugrd') {
                    if (!foundWind) {
                        option.text = 'Surface Wind';
                        option.value = 'wind';
                        option.selected = 'selected';
                        gribTypes.add(option);
                    }
                    foundWind = true;
                } else {
                    option.text = type.gribType.desc;
                    option.value = type.gribType.type;
                    gribTypes.add(option);
                }
            });
    
            gribData = jsonGrib; // gribData is a function prm
            // Min and max for each grib data
            findMinMax(gribData, 0);
    
            redraw();
        };
    
        let findMinMax = (gribData, idx) => { // TODO Call this when GRIB date changes
            let mess = gribData ? `${gribData.length} date(s), from ${gribData[0].gribDate.formattedUTCDate} to ${gribData[gribData.length - 1].gribDate.formattedUTCDate}` : "missing data";
            messageManager(`GRIB data received on client (${mess}), finding min and max for index ${idx}`);
            // console.log("Display min and max for index", idx);
            // messageManager("Finding min and max for index:" + idx);
            let gribObj = gribData[idx];
            console.log(gribObj.gribDate.formattedUTCDate);
            for (let i = 0; i < gribObj.typedData.length; i++) {
                let gribTypeData = gribObj.typedData[i];
                if (gribTypeData.gribType.type !== 'vgrd' && gribTypeData.gribType.type !== 'ugrd') {
                    console.log("Type %s (%s), min=%f, max=%f", gribTypeData.gribType.desc, gribTypeData.gribType.type, gribTypeData.gribType.min, gribTypeData.gribType.max);
                    switch (gribTypeData.gribType.type) {
                        case 'tmp':
                            try {
                                document.getElementById('min-max-atemp').innerText = `Air Temp: min ${(gribTypeData.gribType.min - 273).toFixed(2)}\xB0C, max ${(gribTypeData.gribType.max - 273).toFixed(2)}\xB0C`;
                            } catch (err) {
                            }
                            break;
                        case 'htsgw':
                            try {
                                document.getElementById('max-waves').innerText = `Waves: max ${(gribTypeData.gribType.max).toFixed(2)} m`;
                            } catch (err) {
                            }
                            break;
                        case 'prate':
                            try {
                                document.getElementById('max-prate').innerText = `P-Rate: max ${(3600 * gribTypeData.gribType.max).toFixed(2)} mm/h`;
                            } catch (err) {
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        let displayCompositeInfo = () => {
            // console.log('Displaying');
            let compositeId = document.getElementById('composites').value;
            composeCompositeInfo(compositeId);
        }

        let composeCompositeInfo = (compositeId) => {
            // console.log('Displaying');
            let infoDiv = document.getElementById('composite-info');
            let content = "<h1>Not found</h1>";
            for (let i = 0; i < compositeCatalog.length; i++) {
                if (compositeCatalog[i].key === compositeId) {
                    content = "<h3>" + compositeCatalog[i].name + "</h3>";
                    content += "<ul>";
                    if (compositeCatalog[i].gribRequest !== undefined) {
                        content += ("<li>" + compositeCatalog[i].gribRequest + "</li>");
                    }
                    if (compositeCatalog[i].faxData !== undefined) {
                        compositeCatalog[i].faxData.forEach(fax => {
                            content += ("<li>" + fax.name + "</li>");
                        });
                    }
                    content += "</ul>";
                    break;
                }
            }
            infoDiv.innerHTML = content;
        };
    
        let hideCompositeInfo = () => {
            // console.log('Hiding');
            let infoDiv = document.getElementById('composite-info');
            infoDiv.innerHTML = "";
        };
    
        let makeGRIBRequest = (gribRequest, where) => {
            let rawRequest = gribRequest;
            if (rawRequest === undefined && document.getElementById("grib-request")) {
                rawRequest = document.getElementById("grib-request").value;
            }
            console.log(rawRequest);
            let jsonRequest = {request: rawRequest};
            if (where !== undefined) {
                console.log('... into', where);
                jsonRequest.directory = where;
                gribFileLocation = where; // Used for routing. Directory of grib.grb
                document.getElementById('current-grib-location').innerText = ('GRIB in ' + gribFileLocation);
            }
            worldMap.setAfterDrawing(renderGRIBData); // That is the callback
    
            requestGRIB(jsonRequest, plotGrib);  // TODO Enable GRIB widgets if successful
        };
    
        let renderGRIB = () => {
            let rawGrib = JSON.parse(document.getElementById("json-grib").value);
            worldMap.setAfterDrawing(renderGRIBData);
            plotGrib(rawGrib);
        };
    
        let flipGRIB = (radio) => {
            if (radio.value === 'web') {
                document.getElementById("grib-web").style.display = 'block';
                document.getElementById("grib-json").style.display = 'none';
                document.getElementById("load-composites").disabled = false; // Enable Load Composite button
            } else if (radio.value === 'json') {
                document.getElementById("grib-web").style.display = 'none';
                document.getElementById("grib-json").style.display = 'block';
                document.getElementById("load-composites").disabled = true;  // Disable Load Composite button
            }
        };
    
        let updateGRIBRequest = (option) => {
            let key = option.value;
            for (let i = 0; i < compositeCatalog.length; i++) {
                if (key === compositeCatalog[i].key) {
                    if (document.getElementById("grib-request")) {
                        if (compositeCatalog[i].gribRequest !== undefined) {
                            document.getElementById("grib-request").value = (compositeCatalog[i].gribRequest);
                        } else {
                            document.getElementById("grib-request").value = ('');
                        }
                    }
                    break;
                }
            }
        };
    
        let changeCanvasSize = (factor) => {
            thisZoomFactor *= factor;
            worldMap.setCanvasHeight(worldMap.getCanvasHeight() * factor);
            worldMap.setCanvasWidth(worldMap.getCanvasWidth() * factor);
            // Faxes offset and zoom
            for (let sh = 0; sh < show.length; sh++) {
                speakUp(sh + 1);
            }
            redraw();
        };
    
    </script>
        
</head>
<body style="background-color: rgba(47, 55, 61, 0.95); background-image: none;">
<h2>Weather Wizard. GRIB &amp; Faxes. Pure HTML5/ES6/CSS3. Operations (WiP)<span id="time-to-next"></span></h2>
<div>
    <table width="100%">
        <tr>
            <td valign="top" rowspan="1" style="width: 800px; height: 200px;">
                <div id="map-container" class="map-style" style="padding: 5px; border: 1px solid silver; border-radius: 5px;">
                    <canvas id="mapCanvas" width="1400" height="900"></canvas>
                </div>
            </td>
            <td valign="top" rowspan="4">
                <!--div style="max-width: 350px; height: 600px; resize: both; overflow-x: scroll; overflow-y: scroll;"-->
                <div class="control-style" style="padding: 5px; border: 1px solid silver; border-radius: 5px;">
                    <input type="checkbox" onchange="changeChart(this);" checked/> With Chart&nbsp;
                    <input type="checkbox" onchange="changeGrid(this);" checked/> With Grid&nbsp;
                    <input type="checkbox" onchange="changeTropics(this);"/> With Tropics
                    <br/>
                    <input id="grib-checkbox" type="checkbox" onchange="changeGRIB(this);" disabled/> With GRIB Data
                    <br/>
                    <input id="fax-checkbox" type="checkbox" onchange="changeFAXES(this);" checked/> With Faxes
                    <hr/>
                    <select id="composites" 
                            onchange="updateGRIBRequest(this); displayCompositeInfo();" 
                            onmouseover="displayCompositeInfo();"></select> 
                      <!--  onmouseleave="hideCompositeInfo();"></select --> 
                    <br/>                            
                    <button id="load-composites" onclick="loadComposite();">Load documents</button>

                    <input type="checkbox" onchange="continuousLoad(this);"/>Every 6 hours

                    <div id="composite-info"></div>

                    <hr/>
                    <input type="radio" name="grib-origin" value="web" checked onchange="flipGRIB(this);">From the Web
                    <input type="radio" name="grib-origin" value="json" onchange="flipGRIB(this);">From Server Storage
                    <!-- hr/ -->
                    <div id="grib-web">
                    </div>
                    <div id="grib-json" style="display: none;">
                        <button onclick="getCompositeList();">Get Composites list</button>
                        <input type="text" id="comp-name-filter" placeholder="Composite Name Filter"
                               title="Enter the Composite key, or any part of the name of the directory the composite lives in."/>
                        <div id="composite-list" class="complist-style"></div>
                    </div>
                    <hr/>
                    Zoom for the whole thing:
                    <button onclick="changeCanvasSize(0.9);">-</button>
                    <button onclick="changeCanvasSize(1.1);">+</button>
                    <hr/>
                    <div id="grib-widgets" class="table-style" style="display: none; background: rgba(0, 255, 0, 0.25);">
                        <table>
                            <tr>
                                <th>GRIB Date</th>
                                <th>Data Type</th>
                            </tr>
                            <tr>
                                <td>
                                    <select id="grib-dates" onchange="redraw()"></select>
                                </td>
                                <td>
                                    <select id="grib-types" onchange="redraw()"></select>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2"><input type="checkbox" onchange="scrollGribs(this);">Scroll through
                                    dates
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div id="dyn-faxes" class="table-style" style="background: rgba(0, 255, 0, 0.25);">
                        <!--span>Show faxes checkbox (TODO)</span-->
                        <table id="fax-table" class="bordered">
                            <tr>
                                <th>Show</th>
                                <th>#</th>
                                <th>Name</th>
                                <th>x</th>
                                <th>y</th>
                                <th>zoom</th>
                            </tr>
                        </table>
                    </div>
                    <div id="min-max-data" class="table-style">
                        <div id="max-wind"></div>
                        <div id="min-max-atemp"></div>
                        <div id="max-waves"></div>
                        <div id="max-prate"></div>
                    </div>
                    <div id="mouse-data" class="table-style" style="color: black;"></div>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="1">
                <div id="err-mess"></div>
            </td>
        </tr>
        <tr>
            <!-- Web Components for the GRIB Here -->
            <td title="GRIB Data at the mouse" style="height: 0; border: 1px solid orange; border-radius: 5px;">
                <div id="grib-web-comps" style="display: none;">
                    <div style="display: grid;
                                grid-template-columns: auto auto auto auto auto;
                                grid-template-areas: 'top top top top top' 'middle-01 middle-02 middle-03 middle-04 middle-05' 'bottom bottom bottom bottom bottom';">
                        <span style="grid-area: top; padding-left: 5px;">GRIB Data, at the mouse, on the chart <span id="mouse-pos" style="font-family:'Courier New', Courier, monospace; font-weight: bold;"></span></span>                            
                        <!-- True Wind Speed in knots<br/ -->
                        <analog-display class="analogdisplay-monochrome-orange"
                                        style="grid-area: middle-01;"
                                        title="True Wind Speed in knots"
                                        id="tws-01"
                                        min-value="0"
                                        max-value="60"
                                        value="0"
                                        major-ticks="10"
                                        minor-ticks="1"
                                        with-border="true"
                                        overlap="40"
                                        label="TWS"
                                        width="200"
                                        height="200"></analog-display>

                        <!-- Wind Direction in &deg;<br/ -->
                        <direction-display class="analogdisplay-monochrome-orange analog-for-dir"
                                        style="grid-area: middle-02;"
                                        title="TWD"
                                        id="twd-01"
                                        value="0"
                                        major-ticks="45"
                                        minor-ticks="5"
                                        with-rose="true"
                                        with-border="true"
                                        label="TWD"
                                        width="200"
                                        height="200"></direction-display>

                        <!-- Air Temperature in &deg;C<br/ -->
                        <thermo-meter id="thermometer-01"
                                    class="thermometer-orange"
                                    style="grid-area: middle-03;"
                                    title="Air, Celsius"
                                    min-value="-20"
                                    max-value="50"
                                    major-ticks="10"
                                    minor-ticks="1"
                                    value="0"
                                    unit="C"
                                    width="100"
                                    height="220"></thermo-meter>

                        <!-- Atm Pressure in hPa<br/ -->
                        <analog-display class="analogdisplay-monochrome-orange analog-for-prmsl"
                                        style="grid-area: middle-04;"
                                        title="Pressure in hPa"
                                        id="prmsl-01"
                                        min-value="983"
                                        max-value="1043"
                                        value="1013.6"
                                        major-ticks="10"
                                        minor-ticks="1"
                                        with-border="true"
                                        overlap="40"
                                        label="PRMSL"
                                        width="200"
                                        height="200"></analog-display>

                        <!-- Precipitation Rate in mm/h<br/ -->
                        <pluvio-meter id="rain-01"
                                    class="pluviometer-orange"
                                    style="grid-area: middle-05;"
                                    title="m/m per hour"
                                    min-value="0"
                                    max-value="30"
                                    major-ticks="5"
                                    minor-ticks="0.50"
                                    value="0"
                                    width="80"
                                    height="220"></pluvio-meter>

                        <beaufort-scale id="beaufort-01"
                                        class="beaufort-01"
                                        style="grid-area: bottom;"
                                        title="Beaufort Scale"
                                        value="0.0"
                                        orientation="HORIZONTAL"
                                        width="200"
                                        height="60"></beaufort-scale>
                    </div>                            
                </div>
            </td>
        </tr>
        <tr>
            <td valign="top">
                <!-- Messages -->
                <div id="message-zone" class="mess-zone"></div>
                <button onclick="clearMessZone();" style="margin: 5px;">Clear</button>
            </td>
        </tr>
    </table>
</div>

<!-- For tests, only -->
<hr/>
<div>
    Click on map sets:
    <input type="radio" name="from-to" value="position" id="rb-position" checked>Start from (position)
    <input type="radio" name="from-to" value="going-to" id="rb-going-to">Going to
</div>
Going to: Latitude:
<select id="routing-pos-lat-sign-01">
    <option value="N" selected>N</option>
    <option value="S">S</option>
</select>
<input type="number"
       id="routing-pos-lat-deg-01"
       placeholder="Deg"
       title="Lat degrees to set"
       style="width: 40px; text-align: center;"
       min="0"
       max="90"
       step="1"
       value="0"/>
<input type="number"
       id="routing-pos-lat-min-01"
       placeholder="Minutes"
       title="Lat minutes to set"
       style="width: 60px; text-align: center;"
       min="0"
       max="59.99"
       step="0.01"
       value="00.00"/>
&nbsp;&nbsp;Longitude:
<select id="routing-pos-lng-sign-01">
    <option value="E" selected>E</option>
    <option value="W">W</option>
</select>
<input type="number"
       id="routing-pos-lng-deg-01"
       placeholder="Deg"
       title="Lng degrees to set"
       style="width: 40px; text-align: center;"
       min="0"
       max="180"
       step="1"
       value="0"/>
<input type="number"
       id="routing-pos-lng-min-01"
       placeholder="Minutes"
       title="Lng minutes to set"
       style="width: 60px; text-align: center;"
       min="0"
       max="59.99"
       step="0.01"
       value="00.00"/>
<button onclick="testRouting();" title="Early test, no UI. Work in Progress." style="color: red;">Routing <b><i>Test</i></b></button>
<div style="min-height: 16px;">
    <span id="current-grib-location"></span>
</div>
<!-- End of Test -->

<table width="100%" cellpadding="0" cellspacing="0"> <!--  style="position: fixed; bottom: 0;" -->
    <tr>
    </tr>
    <tr>
        <td valign="top">
            <hr/>
            <address><span id="console-type"></span></address>
        </td>
    </tr>
</table>
</body>

<script type="text/javascript">

    var compositeCatalog = [];

    window.onload = () => {
        init(); // init UI

        canvas = document.getElementById('mapCanvas');
        context = canvas.getContext('2d');

        worldMap.clear();
        worldMap.setMouseMoveCallback(mouseMoveCallback);
        worldMap.setMouseClickCallback(mouseClickCallback);
        worldMap.setPositionLabel("Pos");
        setTimeout(() => {
            worldMap.drawWorldMap();
        }, 1);

        document.getElementById("console-type").innerHTML = 'The HTML5 ' + flavor + ' Console.';

        document.getElementById("map-container").height = (window.innerHeight * 0.80);

        // Populate composites list
        if (false) { // Old method. TO BE REMOVED.
            setTimeout(() => { // compositeCatalog populated by a Promise in catalog.js... Not elegant, fix that.
            for (let i = 0; i < compositeCatalog.length; i++) {
                let opt = document.createElement('option');
                opt.setAttribute('value', compositeCatalog[i].key);
                opt.appendChild(document.createTextNode(compositeCatalog[i].name));
                document.getElementById('composites').appendChild(opt);
                if (i === 0) {
                    if (compositeCatalog[i].gribRequest !== undefined && document.getElementById("grib-request")) {
                        document.getElementById("grib-request").value = (compositeCatalog[i].gribRequest);
                    }
                }
            } }, 2000);
        }

        const URL = '../catalog/compositeCatalog.json';	

        fetch(URL)
            .then(
                response => {
                    console.log(`Response: ${response.ok}`);
                    compositeCatalog = response.json().then(doc => {
                        compositeCatalog = doc;
                        console.log(`Composites Catalog loaded, ${doc.length} elements`); 

                        // Now populate the drop-down list.
                        for (let i = 0; i < compositeCatalog.length; i++) {
                            let opt = document.createElement('option');
                            opt.setAttribute('value', compositeCatalog[i].key);
                            opt.appendChild(document.createTextNode(compositeCatalog[i].name));
                            document.getElementById('composites').appendChild(opt);
                            if (i === 0) {
                                if (compositeCatalog[i].gribRequest !== undefined && document.getElementById("grib-request")) {
                                    document.getElementById("grib-request").value = (compositeCatalog[i].gribRequest);
                                }
                            }
                        }
                    });
                }, 
                (error, errmess) => {
                    console.log("Ooch");
                    let message;
                    if (errmess) {
                        let mess = JSON.parse(errmess);
                        if (mess.message) {
                            message = mess.message;
                        }
                    }
                    console.debug("Failed to get Composite Catalog..." + (error ? JSON.stringify(error, null, 2) : ' - ') + ', ' + (message ? message : ' - '));
                });

    };

</script>

</html>
