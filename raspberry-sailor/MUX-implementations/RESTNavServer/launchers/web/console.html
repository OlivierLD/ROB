<!DOCTYPE html>
<!--
  With Displays, Overview, Map, TW Evolution, CurrentEvolution

  @Deprecated
  - Use the WebComponents version (in the webcomponents directory)
-->
<html>
  <head>
    <!--meta charset="windows-1252"-->
    <!--meta charset="iso-8859-1"-->
    <!--meta charset="utf-8"-->
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
    <title>NMEA Console Data</title>

    <link rel="icon" type="image/ico" href="icons/hammerhead.02.ico">

    <link rel="stylesheet" href="css/stylesheet.css" type="text/css"/>
    <style type="text/css">
      .displayCanvas {
        border: 1px solid #9C9898;
        opacity:0.75;
      }

      .selectedButton {
        padding: 5px;
        border-top-right-radius: 10px;
        border: 1px solid #CCC;
        margin-top: 10px;
        border-bottom: none;
        font-size: 12px;
        font-weight: bold;
				cursor: pointer;
      }

      .unselectedButton {
        padding: 5px;
        border-top-right-radius: 10px;
        border: 1px solid #CCC;
        margin-top: 10px;
        border-bottom: none;
        font-size: 12px;
        font-weight: normal;
				cursor: pointer;
      }
    </style>
    <link rel="stylesheet" href="css/black.01.css" type="text/css" id="theme"/>
    <!-- TODO Remove that when moved to ES6 (ajax.manager.js) -->
    <script type="text/javascript" src="js/jquery-2.1.3.js"></script>

    <script type="text/javascript" src="js/date.proto.js"></script>
    <script type="text/javascript" src="widgets/AnalogDisplay.js"></script>
    <script type="text/javascript" src="widgets/NumericDisplay.js"></script>
    <script type="text/javascript" src="widgets/CompassRose.js"></script>
    <script type="text/javascript" src="widgets/BoatOverview.js"></script>
    <script type="text/javascript" src="widgets/Thermometer.js"></script>
    <script type="text/javascript" src="widgets/Direction.js"></script>
    <script type="text/javascript" src="widgets/JumboDisplay.js"></script>
    <script type="text/javascript" src="widgets/AWDisplay.js"></script>
    <script type="text/javascript" src="widgets/CurrentDisplay.js"></script>
    <script type="text/javascript" src="widgets/DateDisplay.js"></script>
    <script type="text/javascript" src="widgets/TimeDisplay.js"></script>
    <script type="text/javascript" src="widgets/DirectionEvolution.js"></script>
    <script type="text/javascript" src="widgets/SpeedEvolution.js"></script>
    <script type="text/javascript" src="js/routes.utils.js"></script>
    <script type="text/javascript" src="widgets/WorldMapData.js"></script>
    <script type="text/javascript" src="widgets/worldmap.js"></script>
    <script type="text/javascript" src="js/pub.sub.js"></script>
    <script type="text/javascript" src="js/ajax.manager.js"></script>
    <script type="text/javascript" src="js/ws.manager.js"></script>
    <script type="text/javascript" src="js/conversion.utils.js"></script>
    <script type="text/javascript" src="js/console.js"></script>
    <script type="text/javascript">

  var lastKnownPosition;

  var getQSPrm = function(prm) {
    var value;
    var loc = document.location.toString();
    if (loc.indexOf("?") > -1) {
      var qs = loc.substring(loc.indexOf("?") + 1);
      var prms = qs.split('&');
      for (var i=0; i<prms.length; i++) {
        var nv = prms[i].split('=');
        if (nv.length === 2) {
          if (nv[0] === prm) {
            return nv[1];
          }
        }
      }
    }
    return value;
  };

  var setup = function(b1, b2, b3, b4, b5) {
    document.getElementById('displays').style.display = (b1 === true ? 'inline' : 'none');
    document.getElementById('overview').style.display = (b2 === true ? 'inline' : 'none');
    document.getElementById('map').style.display = (b3 === true ? 'inline' : 'none');
    document.getElementById('twd-evolution').style.display = (b4 === true ? 'inline' : 'none');
	  document.getElementById('current-evolution').style.display = (b5 === true ? 'inline' : 'none');

    document.getElementById('showDisplays').className = (b1 === true ? 'selectedButton' : 'unselectedButton');
    document.getElementById('showOverview').className = (b2 === true ? 'selectedButton' : 'unselectedButton');
    document.getElementById('showMap').className = (b3 === true ? 'selectedButton' : 'unselectedButton');
    document.getElementById('showTWDEvolution').className = (b4 === true ? 'selectedButton' : 'unselectedButton');
	  document.getElementById('showCurrentEvolution').className = (b5 === true ? 'selectedButton' : 'unselectedButton');
  };

  var showMap = function() {
    setup(false, false, true, false, false);
  };
  var showDisplays = function() {
    setup(true, false, false, false, false);
  };
  var showOverview = function() {
    setup(false, true, false, false, false);
  };
  var showTWDEvolution = function() {
    setup(false, false, false, true, false);
  };
  var showCurrentEvolution = function() {
	  setup(false, false, false, false, true);
	}

  var LATITUDE  = 0;
  var LONGITUDE = 1;
  var DURATION_FMT = "Y-m-dTH:i:s";

  var toDMS = function (val, flavor) {
	  var str = "";
	  var value = val;
	  if (val < 0) {
		  value = -val;
		  str = (flavor === LATITUDE ? "S" : "W");
	  } else {
		  str = (flavor === LATITUDE ? "N" : "E");
	  }
	  var deg = Math.floor(value).toFixed(0);
	  str += (" " + deg + "&deg;");
	  var min = (value - deg) * 60;
	  str += (min.toFixed(2) + "'");
	  return str;
  };

  var flavor = 'Ajax'; // Default, WebSocket not implemented here (we run on a small http server).

  window.onload = () => {
    init(); // init UI

	  worldMap.clear();
    setTimeout(() => {
	    worldMap.drawWorldMap();
    }, 1);

    var type = getQSPrm('type');
    if (type === 'WS') {
      initWS();
      flavor = 'WebSocket';
    } else {
      initAjax(); // Default
    }
    document.getElementById("console-type").innerHTML = 'The HTML5 ' + flavor + ' Console.';
    resizeComponents();
    var theme = getQSPrm('theme');
    if (theme !== undefined) {
      changeTheme(theme);
    }
    var border = getQSPrm('border');
    if (border !== undefined) {
      changeBorder(border === 'Y');
      var cb = document.getElementById('with-border');
      cb.checked = (border === 'Y');
    }
    /**
		 *  SUBSCRIBERS HERE.
		 *
     * The following subscriptions make the distinction between Ajax & WebSockets
     * (See the initAjax & initWS methods)
     */
    events.subscribe('pos', function(val) {
      var label = "Your position";
      // Plot the station on the map
      var canvas = "mapCanvas";
	    worldMap.clear();
	    worldMap.drawWorldMap();
	    lastKnownPosition = { latitude: val.lat, longitude: val.lng };
	    worldMap.setUserPosition(lastKnownPosition);
    });
    events.subscribe('bsp', function(val) {
//    displayBSP.animate(bsp);
      displayBSP.setValue(val);
      displayOverview.setBSP(val);
      jumboBSP.setValue(val.toFixed(2));
    });
    events.subscribe('log', function(val) {
      displayLog.setValue(val);
	    displayBSP.setDigitValue(val);
    });
    events.subscribe('gps-time', function(val) {
      displayDate.setValue(val);
      displayTime.setValue(val);
      // Require astronomical data for the map
	    var date = new Date(val);
	    var mess = "Time is now " + new Date(date).format("Y-M-d H:i:s UTC");
	    var dateField = document.getElementById("current-date");
	    if (dateField !== undefined) {
		    dateField.innerText = mess;
	    }
        try {
		  getAstroData(lastKnownPosition, date.format(DURATION_FMT), onAstroData);
		} catch (err) {
		  console.log("Bam!", err);
		}
    });
    events.subscribe('hdg', function(val) {
//    displayHDG.animate(val);
      displayHDG.setValue(val);
      displayOverview.setHDG(val);
      jumboHDG.setValue(lpad(Math.round(val).toString(), '0', 3));
      rose.setValue(Math.round(val));
    });
    events.subscribe('twd', function(val) {
//    displayTWD.animate(val);
      displayTWD.setValue(val);
      displayOverview.setTWD(val);
      jumboTWD.setValue(lpad(Math.round(val).toString(), '0', 3));
      twdEvolution.addDirection({ "angle": val,
                            "time": (new Date()).getTime() });
    });
    events.subscribe('twa', function(val) {
      val = val.toFixed(0);
      displayOverview.setTWA(val);
      var twaStr = lpad(Math.round(Math.abs(val)).toString(), '0', 3);
      if (val < 0) {
	      twaStr = '-' + twaStr;
      } else {
	      twaStr += '-';
      }
      jumboTWA.setValue(twaStr);
    });
    events.subscribe('tws', function(val) {
//    displayTWS.animate(val);
      displayTWS.setValue(val);
      displayOverview.setTWS(val);
      jumboTWS.setValue(val.toFixed(1));
      twsEvolution.addSpeed({ "speed": val, "time": (new Date()).getTime() });

      var from = twsEvolution.getFromBoundary();
      var to   = twsEvolution.getToBoundary();

      var dateFmt = (to - from > (3600000 * 24)) ? "d-M H:i:s" : "H:i:s"; // "d-M-Y H:i:s._ Z";
      document.getElementById("life-span").innerHTML = twsEvolution.getBufferLength() + " pts<br>" +
                                                       "From " + (new Date(from)).format(dateFmt) + "<br>" +
                                                       "To " + (new Date(to)).format(dateFmt) + "<br>" +
                                                    // "(" + twsEvolution.getLifeSpan() + ")" + "<br>" +
                                                       twsEvolution.getLifeSpanFormatted();
    });
    events.subscribe('wt', function(val) {
//    thermometer.animate(val);
      thermometer.setValue(val);
    });
    events.subscribe('at', function(val) {
//    athermometer.animate(val);
      athermometer.setValue(val);
    });
    events.subscribe('volt', function(val) {
//    displayVolt.animate(val);
      displayVolt.setValue(val);
    });
    events.subscribe('prmsl', function(val) {
//    displayBaro.animate(val);
      displayBaro.setValue(val);
    });
    events.subscribe('hum', function(val) {
//    displayHum.animate(val);
      displayHum.setValue(val);
    });
    events.subscribe('aws', function(val) {
      displayAW.setAWS(val);
      displayOverview.setAWS(val);
      jumboAWS.setValue(val.toFixed(1));
    });
    events.subscribe('awa', function(val) {
      var awa = val.toFixed(0);
//    displayAW.animate(awa);
      displayAW.setValue(val);
      displayOverview.setAWA(val);
      var awaStr = lpad(Math.round(Math.abs(val)).toString(), '0', 3);
      if (awa < 0) {
	      awaStr = '-' + awaStr;
      } else {
	      awaStr += '-';
      }
      jumboAWA.setValue(awaStr);
    });
    events.subscribe('cdr', function(val) {
      var cdr = val.toFixed(0);
      displayOverview.setCDR(val);
      jumboCDR.setValue(lpad(Math.round(val).toString(), '0', 3));
      displayCurrent.setValue(val);
	    currentDirEvolution.addDirection({ "angle": val,
		    													       "time": (new Date()).getTime() });
	    var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
	    if (evolutionFlavor === 'inst') {
		    displayCurrent2.setValue(val);
	    }
    });
	  events.subscribe('csp', function(val) {
		  var csp = val.toFixed(2);
		  displayOverview.setCSP(val);
		  jumboCSP.setValue(csp);
		  displayCurrent.setCurrentSpeed(val);
		  currentSpeedEvolution.addSpeed({ "speed": val,
				                               "time": (new Date()).getTime() });
		  var from = currentSpeedEvolution.getFromBoundary();
		  var to   = currentSpeedEvolution.getToBoundary();

		  var dateFmt = (to - from > (3600000 * 24)) ? "d-M H:i:s" : "H:i:s"; // "d-M-Y H:i:s._ Z";
		  document.getElementById("life-span-current").innerHTML = currentSpeedEvolution.getBufferLength() + "&nbsp;pts<br>" +
				  "From&nbsp;" + (new Date(from)).format(dateFmt) + "<br>" +
				  "To&nbsp;" + (new Date(to)).format(dateFmt) + "<br>" +
				  // "(" + twsEvolution.getLifeSpan() + ")" + "<br>" +
				  currentSpeedEvolution.getLifeSpanFormatted();
				  currentSpeedEvolution.getLifeSpanFormatted();
			var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
			if (evolutionFlavor === 'inst') {
				displayCurrent2.setCurrentSpeed(val);
			}
	  });

	  events.subscribe("csp-30000", function(val) {
		  currentSpeedEvolution30s.addSpeed({ "speed": val,
			  																	"time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '30s') {
			  displayCurrent2.setCurrentSpeed(val);
		  }
		});
	  events.subscribe("cdr-30000", function(val) {
		  currentDirEvolution30s.addDirection({ "angle": val,
			  																		"time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '30s') {
			  displayCurrent2.setValue(val);
		  }
	  });
	  events.subscribe("csp-60000", function(val) {
		  currentSpeedEvolution1m.addSpeed({ "speed": val,
			  																 "time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '1m') {
			  displayCurrent2.setCurrentSpeed(val);
		  }
	  });
	  events.subscribe("cdr-60000", function(val) {
		  currentDirEvolution1m.addDirection({ "angle": val,
				 																	 "time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '1m') {
			  displayCurrent2.setValue(val);
		  }
	  });
	  events.subscribe("csp-600000", function(val) {
		  currentSpeedEvolution10m.addSpeed({ "speed": val,
																					"time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '10m') {
			  displayCurrent2.setCurrentSpeed(val);
		  }
	  });
	  events.subscribe("cdr-600000", function(val) {
		  currentDirEvolution10m.addDirection({ "angle": val,
			  																		"time": (new Date()).getTime() });
		  var evolutionFlavor = getRadioButtonValue("buffer-size-rb");
		  if (evolutionFlavor === '10m') {
			  displayCurrent2.setValue(val);
		  }
	  });

    events.subscribe('cog', function(val) {
      var cog = val.toFixed(0);
      displayOverview.setCOG(val);
      jumboCOG.setValue(lpad(Math.round(val).toString(), '0', 3));
    });
    events.subscribe('cmg', function(val) {
      displayOverview.setCMG(val);
    });
    events.subscribe('leeway', function(val) {
      displayOverview.setLeeway(val);
      var lwyStr = lpad(Math.round(Math.abs(val)).toString(), '0', 2);
      if (val < 0) {
	      lwyStr = '-' + lwyStr;
      } else {
	      lwyStr += '-';
      }
      jumboLWY.setValue(lwyStr);
    });
    events.subscribe('sog', function(val) {
      val = val.toFixed(2);
      displayOverview.setSOG(val);
      jumboSOG.setValue(val);
    });
    events.subscribe('wp', function(val) {
      displayOverview.setB2WP(val.b2wp.toFixed(0));
      document.getElementById("display.vmg.waypoint").disabled = false;
      document.getElementById("display.vmg.waypoint").value = val.to_wp;
      document.getElementById("display.vmg.waypoint").nextSibling.textContent = "VMG (aka ZMG) to " + val.to_wp;
    });
    events.subscribe('vmg', function(val) {
      var vmg = 0;
      if (document.getElementById("display.vmg.wind").checked) {
	      vmg = val.onwind.toFixed(2);
      } else {
	      vmg = val.onwp.toFixed(2);
      }
      displayOverview.setVMG(vmg);
      jumboVMG.setValue(vmg);
    });
  };

  const months = [ "Jan", "Feb", "Mar", "Apr", "May", "Jun",
	  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ];

  var onAstroData = function(data) {
		var sunLHA = data.sun.gha + data.from.longitude;
		while (sunLHA < 0) sunLHA +=360;
		while (sunLHA > 360) sunLHA -= 360;
		var moonLHA = data.moon.gha + data.from.longitude;
		while (moonLHA < 0) moonLHA +=360;
		while (moonLHA > 360) moonLHA -= 360;
		document.getElementById("sun-moon-data").innerHTML =
				'<table border="0"><tr><td>Sun D:</td><td align="right">' +
				decToSex(data.sun.decl, "NS") +
				'</td></tr><tr><td>Sun GHA:</td><td align="right">' +
				decToSex(data.sun.gha) +
				'</td><td>&nbsp;LHA:</td><td align="right">' +
				decToSex(sunLHA) +
				'</td></tr><tr><td>Sun Alt:</td><td align="right">' +
				decToSex(data.sunObs.alt) +
				'</td></tr><tr><td>Sun Z:</td><td align="right">' +
				decToSex(data.sunObs.z) +

				'</td></tr><tr><td>Moon D:</td><td align="right">' +
				decToSex(data.moon.decl, "NS") +
				'</td></tr><tr><td>Moon GHA:</td><td align="right">' +
				decToSex(data.moon.gha) +
				'</td><td>&nbsp;LHA:</td><td align="right">' +
				decToSex(moonLHA) +
				'</td></tr><tr><td>Moon Alt:</td><td align="right">' +
				decToSex(data.moonObs.alt) +
				'</td></tr><tr><td>Moon Z:</td><td align="right">' +
				decToSex(data.moonObs.z) +
				'</td></tr></table>';

		document.getElementById("solar-date").innerHTML =
				data.solarDate.year + ' ' +
				months[data.solarDate.month - 1] + ' ' +
				(data.solarDate.day < 10 ? '0' : '') + data.solarDate.day + ' ' +
				(data.solarDate.hour < 10 ? '0' : '') + data.solarDate.hour + ':' +
				(data.solarDate.min < 10 ? '0' : '') + data.solarDate.min + ':' +
				(data.solarDate.sec < 10 ? '0' : '') + data.solarDate.sec;

		document.getElementById("sun-meridian").innerHTML =
				(data.tPass.hour < 10 ? '0' : '') + data.tPass.hour + ':' +
				(data.tPass.min < 10 ? '0' : '') + data.tPass.min + ':' +
				(data.tPass.sec < 10 ? '0' : '') + data.tPass.sec + ' ' +
				data.tPass.tz;

		worldMap.setAstronomicalData(data);
	};

  var getRadioButtonValue = function(rbName) {
  	var elmts = document.getElementsByName(rbName);
  	var value;
  	if (elmts !== undefined && elmts !== null) {
		  for (var idx = 0; idx < elmts.length; idx++) {
				if (elmts[idx].checked) {
					value = elmts[idx].value;
					break;
				}
		  }
	  }
		return value;
	};

  var displayErr = function(err) {
    if (err !== undefined) {
	    document.getElementById("err-mess").innerHTML = ("<small>" + err + "</small>");
    }
  };

  window.onresize = function() {
//  console.log("Re-evaluating window size");
    resizeComponents();
  };

  var resizeComponents = function() {
    var ww = window.innerWidth;
    var wh = window.innerHeight;

    var totalWidth = TOTAL_WIDTH; // in console.js

    // Canvases & iFrame
    document.getElementById('overviewCanvas').height = wh * 0.8;
    // BSP
    document.getElementById('bspCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
//  document.getElementById('bspCanvas').height = 120 * (Math.min(ww, totalWidth) / totalWidth);
	  document.getElementById('bspCanvas').height = 240 * (Math.min(ww, totalWidth) / totalWidth);
    // HDG
    document.getElementById('hdgCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('hdgCanvas').height = 220 * (Math.min(ww, totalWidth) / totalWidth);
    // TWD
    document.getElementById('twdCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('twdCanvas').height = 220 * (Math.min(ww, totalWidth) / totalWidth);
    // TWS
    document.getElementById('twsCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('twsCanvas').height = 220 * (Math.min(ww, totalWidth) / totalWidth);
    // TEMP
    document.getElementById('tmpCanvas').width = 100 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('tmpCanvas').height = 240 * (Math.min(ww, totalWidth) / totalWidth);

    document.getElementById('atmpCanvas').width = 100 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('atmpCanvas').height = 240 * (Math.min(ww, totalWidth) / totalWidth);
    // Baro
    document.getElementById('baroCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('baroCanvas').height = 220 * (Math.min(ww, totalWidth) / totalWidth);
    // Humidity
    document.getElementById('humCanvas').width = 240 * (Math.min(ww, totalWidth) / totalWidth);
    document.getElementById('humCanvas').height = 220 * (Math.min(ww, totalWidth) / totalWidth);

    // Jumbos
    var jumboCanvasList = ['jumboBSPCanvas', 'jumboTWDCanvas', 'jumboHDGCanvas', 'jumboLWYCanvas',
                           'jumboAWACanvas', 'jumboTWACanvas', 'jumboAWSCanvas', 'jumboTWSCanvas',
                           'jumboCOGCanvas', 'jumboCDRCanvas', 'jumboSOGCanvas', 'jumboCSPCanvas',
                           'jumboVMGCanvas'];
    var jumboFactor = ww / totalWidth;
    for (var i=0; i<jumboCanvasList.length; i++) {
      document.getElementById(jumboCanvasList[i]).width  = 120 * jumboFactor;
      document.getElementById(jumboCanvasList[i]).height =  60 * jumboFactor;
    }
    document.getElementById('twdEvolutionCanvas').height = wh * 0.8;
    document.getElementById('twsEvolutionCanvas').height = wh * 0.8;

	  document.getElementById('currentDirEvolutionCanvas').height = wh * 0.8;
	  document.getElementById('currentSpeedEvolutionCanvas').height = wh * 0.8;

	  document.getElementById('currentDirEvolutionCanvas30s').height = wh * 0.8;
	  document.getElementById('currentSpeedEvolutionCanvas30s').height = wh * 0.8;
	  document.getElementById('currentDirEvolutionCanvas1m').height = wh * 0.8;
	  document.getElementById('currentSpeedEvolutionCanvas1m').height = wh * 0.8;
	  document.getElementById('currentDirEvolutionCanvas10m').height = wh * 0.8;
	  document.getElementById('currentSpeedEvolutionCanvas10m').height = wh * 0.8;
    // Displays inside the canvases
    resizeDisplays(ww);
  };

  var changeTheme = function(value) {

	  var cssLink = document.getElementById("theme");
	  var newCssLoc = cssLink.href.substring(0, cssLink.href.lastIndexOf("/")) + "/" + value;
	  cssLink.href = newCssLoc;
	  console.log("Replacing " + cssLink.href + " with " + newCssLoc);
	  events.publish('color-scheme-changed', value); // Name is not used...
	  // Repaint the displays ?
	  setTimeout(function() {
		  displayBaro.repaint();
		  displayHum.repaint();
		  thermometer.repaint();
		  athermometer.repaint();
	  }, 1000);
  };

  var resetTWBuffer = function() {
    if (twdEvolution !== undefined) twdEvolution.resetDirection();
    if (twsEvolution !== undefined) twsEvolution.resetSpeed();
  };

  var resetTW2Buffer = function() {
    if (twdEvolution !== undefined) twdEvolution.reset2Direction();
    if (twsEvolution !== undefined) twsEvolution.reset2Speed();
  };

  var resetCurrBuffer = function() {
	  if (currentDirEvolution !== undefined) currentDirEvolution.resetDirection();
	  if (currentSpeedEvolution !== undefined) currentSpeedEvolution.resetSpeed();

	  if (currentDirEvolution30s !== undefined) currentDirEvolution30s.resetDirection();
	  if (currentSpeedEvolution30s !== undefined) currentSpeedEvolution30s.resetSpeed();
	  if (currentDirEvolution1m !== undefined) currentDirEvolution1m.resetDirection();
	  if (currentSpeedEvolution1m !== undefined) currentSpeedEvolution1m.resetSpeed();
	  if (currentDirEvolution10m !== undefined) currentDirEvolution10m.resetDirection();
	  if (currentSpeedEvolution10m !== undefined) currentSpeedEvolution10m.resetSpeed();
  };

  var resetCurr2Buffer = function() {
	  if (currentDirEvolution !== undefined) currentDirEvolution.reset2Direction();
	  if (currentSpeedEvolution !== undefined) currentSpeedEvolution.reset2Speed();

	  if (currentDirEvolution30s !== undefined) currentDirEvolution30s.reset2Direction();
	  if (currentSpeedEvolution30s !== undefined) currentSpeedEvolution30s.reset2Speed();
	  if (currentDirEvolution1m !== undefined) currentDirEvolution1m.reset2Direction();
	  if (currentSpeedEvolution1m !== undefined) currentSpeedEvolution1m.reset2Speed();
	  if (currentDirEvolution10m !== undefined) currentDirEvolution10m.reset2Direction();
	  if (currentSpeedEvolution10m !== undefined) currentSpeedEvolution10m.reset2Speed();
  };

  var handleRadioValue = function(radio) {
    var val = radio.value;
//  console.log("Radio:" + val);
    if (val === "wind") {
      displayOverview.setVMGonWind();
      jumboVMG.setTitle("VMG");
    } else {
      displayOverview.setVMGto(val);
      jumboVMG.setTitle(val);
    }
  };

  var changeGrid = function(cb) {
	  worldMap.setWithGrid(cb.checked);
  };
  var changeSun = function(cb) {
	  worldMap.setWithSun(cb.checked);
  };
  var changeMoon = function(cb) {
	  worldMap.setWithMoon(cb.checked);
  };
  var changeSunlight = function(cb) {
	  worldMap.setWithSunLight(cb.checked);
  };
  var changeMoonlight = function(cb) {
	  worldMap.setWithMoonLight(cb.checked);
  };
  var changeWanderingBodies = function(cb) {
    worldMap.setWithWanderingBodies(cb.checked);
  };
  var changeTropics = function(cb) {
    worldMap.setWithTropics(cb.checked);
  };

		</script>
  </head>
  <body  style="background-color: rgba(255, 255, 255, 0.2); background-image: none;">
		<div style="display: none;">
			<img src="images/moon-white.png" id="moon-png" />
			<img src="images/sun-white.png" id="sun-png" />
		</div>
		<div style="margin-bottom: 0px;">
      <span id="showDisplays" onclick="showDisplays();" class="selectedButton">Displays</span>
      <span id="showOverview" onclick="showOverview();" class="unselectedButton">Overview</span>
      <span id="showMap" onclick="showMap();" class="unselectedButton">Map</span>
      <span id="showTWDEvolution" onclick="showTWDEvolution();" class="unselectedButton">TW Evolution</span>
			<span id="showCurrentEvolution" onclick="showCurrentEvolution();" class="unselectedButton">Current Evolution</span>
			<span>
				&nbsp;&nbsp;Color Scheme:&nbsp;
				<select id="css-select" onchange="cssSelectManager();" title="Page StyleSheet">
					<option value="black.01.css">Night</option>
					<option value="white.01.css">Day</option>
					<option value="black.02.css">Night/cyan</option>
					<option value="black.03.css">Night/orange</option>
					<option value="white.02.css">Day/Flat</option>
					<!-- More here if needed -->
				</select>
				&nbsp;&nbsp;
				<input type="checkbox" id="with-border" checked onclick="changeBorder(this.checked);">With Border
			</span>
		</div>
    <hr style="margin-top: 1px;">
    <div id="displays" style="display: inline;">
      <!-- Analog Displays -->
      <table align="center" border="0">
        <tr>
          <td align="center">Boat Speed and Log</td>
          <td align="center">Heading in &deg;</td>
          <td align="center">Wind Dir in &deg;</td>
          <td align="center">Wind in knots</td>
          <td align="center"><div id="display-wt-title">Water&deg;C</div></td>
          <td align="center"><div id="display-at-title">Air&deg;C</div></td>
        </tr>
        <tr>
          <td align="center" valign="top" rowspan="2">
            <table border="0">
              <tr>
                <td align="center" valign="top">
                  <!--canvas id="bspCanvas" width="240" height="120" title="Boat Speed in knots"></canvas-->
                  <canvas id="bspCanvas" width="240" height="240" title="Boat Speed in knots, plus log"></canvas>
                </td>
              </tr>
              <tr>
                <td align="center" valign="top">
                  <canvas id="logCanvas" width="120" height="40" title="Log"></canvas>
                </td>
              </tr>
            </table>
          </td>
          <td align="center" valign="top" rowspan="1">
            <canvas id="hdgCanvas" width="240" height="220" title="Heading in degrees"></canvas>
          </td>
          <td align="center" valign="top" rowspan="1">
            <canvas id="twdCanvas" width="240" height="220" title="True Wind Direction in degrees"></canvas>
          </td>
          <td align="center" valign="top" rowspan="1">
            <canvas id="twsCanvas" width="240" height="220" title="True Wind Speed in knots"></canvas>
          </td>
          <td align="center" valign="top" rowspan="1">
            <div id="display-wt-div"><canvas id="tmpCanvas" width="100" height="240" title="Water Temperature in Celcius"></canvas></div>
          </td>
          <td align="center" valign="top" rowspan="2">
            <div id="display-at-div"><canvas id="atmpCanvas" width="100" height="240" title="Air Temperature in Celcius"></canvas></div>
          </td>
        </tr>
        <tr>
          <td align="center" valign="top" colspan="3">
            <canvas id="roseCanvas" width="500" height="50" title="True Heading"></canvas>
          </td>
        </tr>
        <tr>
          <td align="center"><div id="display-gdt-title" style="display: inline;">GPS Date / Time</div></td>
          <td align="center" colspan="3"></td>
        </tr>
        <tr>
          <td align="center" valign="top">
            <div id="display-gdt-div" style="display: inline">
              <canvas id="dateCanvas" width="216" height="40" title="GPS Date"></canvas>
              <br>
              <canvas id="timeCanvas" width="192" height="40" title="GPS Time"></canvas>
            </div>
          </td>
          <td align="center" valign="top" colspan="3">
            <table border="0">
              <tr>
                <td align="center"><div id="display-prmsl-title" style="display: inline;">Barometer in hPa</div></td>
                <td align="center"><div id="display-hum-title" style="display: inline;">Rel. Humidity in %</div></td>
              </tr>
              <tr>
                <td align="center"><div id="display-prmsl-div" style="display: inline;"><canvas id="baroCanvas" width="240" height="220" title="Atmospheric Pressure in hPa"></canvas></div></td>
                <td align="center"><div id="display-hum-div" style="display: inline;"><canvas id="humCanvas" width="240" height="220" title="Relative Humidity in %"></canvas></div></td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </div>
    <div id="overview" style="display: none;">
      <p align="center">
        <table align="center">
          <tr>
            <td align="left" valign="top" rowspan="7">
              <!-- Check boxes -->
              <input type="checkbox" checked="true" id="display.current">Display Current</input>
              <br>
              <input type="checkbox" checked="true" id="display.labels">Display Labels</input>
              <br>
              <input type="checkbox" checked="true" id="display.vmg">Display VMG</input>
              <br>
              <!--
              <input type="checkbox" checked="true" id="display.perf">Display Performance</input>
              <br>
              -->
              <br>
              <input type="radio" name="vmg" checked="true" id="display.vmg.wind" value="wind" onclick="handleRadioValue(this);">VMG on Wind</input>
              <br>
              <input type="radio" name="vmg" id="display.vmg.waypoint" value="wp" onclick="handleRadioValue(this);">VMG on waypoint (aka ZMG)</input>
              <br>
              <br>
              <canvas id="awDisplayCanvas" height="180" width="180" title="Apparent Wind, speed and direction"><!-- class="displayCanvas" --></canvas>
              <br>
              <canvas id="currentDisplayCanvas" height="180" width="180" title="Instant Current, speed and direction"><!-- class="displayCanvas" --></canvas>
            </td>
            <td align="center" valign="top" rowspan="7">
              <canvas id="overviewCanvas" height="500" width="600" class="displayCanvas"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboBSPCanvas" width="120" height="60" title="Boat Speed in knots"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboTWDCanvas" width="120" height="60" title="True Wind Direction in degrees"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboHDGCanvas" width="120" height="60" title="Boat True Heading in degrees"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboLWYCanvas" width="120" height="60" title="Leeway in degrees"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboAWACanvas" width="120" height="60" title="Apparent Wind Angle in degrees"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboTWACanvas" width="120" height="60" title="True Wind Angle in degrees"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboAWSCanvas" width="120" height="60" title="Apparent Wind Speed in knots"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboTWSCanvas" width="120" height="60" title="True Wind Speed in knots"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboCOGCanvas" width="120" height="60" title="Course Over Ground in degrees"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboCDRCanvas" width="120" height="60" title="Direction of the Current in degrees"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboSOGCanvas" width="120" height="60" title="Speed Over Ground in knots"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboCSPCanvas" width="120" height="60" title="Speed of the Current in knots"></canvas>
            </td>
          </tr>
          <tr>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <canvas id="jumboVMGCanvas" width="120" height="60" title="VMG in knots"></canvas>
            </td>
            <td align="center" valign="top">
              <!-- Digital displays -->
              <!--canvas id="jumboCSPCanvas" width="120" height="60" title="Speed of the Current in knots"></canvas-->
            </td>
          </tr>
        </table>
      </p>
    </div>
    <div id="map" style="display: none; height: 450px; width: 850px;">
			<table border="1">
				<tr>
					<td valign="top" rowspan="4">
						<p align="center">
							<canvas id="mapCanvas" width="800" height="400" style="border-radius:10px;"></canvas>
						</p>
					</td>
					<td valign="top">
						<div id="current-date"> --- </div>
						<input type="checkbox" onchange="changeGrid(this);" checked/> With Grid&nbsp;
						<input type="checkbox" onchange="changeTropics(this);" /> With Tropics
						<br/>
						<input type="checkbox" onchange="changeSun(this);" checked/> With Sun
						<br/>
						<input type="checkbox" onchange="changeMoon(this);" checked/> With Moon
						<br/>
						<input type="checkbox" onchange="changeSunlight(this);" /> With Sun light
						<br/>
						<input type="checkbox" onchange="changeMoonlight(this);" /> With Moon light
						<br />
						<input type="checkbox" onchange="changeWanderingBodies(this);" /> With Wandering Bodies
	        </td>
	      </tr>
				<tr>
					<td valign="bottom">
						<i>Sun Transit Time (at your location)</i>
						<br />
						<div id="sun-meridian"></div>
					</td>
				</tr>
				<tr>
					<td valign="bottom">
						<i>Solar Date (at your location)</i>
						<br />
						<div id="solar-date"></div>
					</td>
				</tr>
		    <tr>
			    <td valign="bottom">
				    <i>Sun and Moon</i>
				    <br />
				    <div id="sun-moon-data"></div>
			    </td>
		    </tr>
			</table>
    </div>
    <div id="twd-evolution" style="display: none;">
      <p align="center">
        <table align="center" cellspacing="10">
          <tr>
            <td valign="top" align="right">
              <button onclick="resetTWBuffer();" style="margin-bottom: 10px;">Reset All</button>
              <br>
              <button onclick="resetTW2Buffer();" style="margin-bottom: 10px;">Drop Oldest Half</button>
							<br>
							Max&nbsp;nb&nbsp;pts:<input type="text" style="text-align: right;" size="6" placeholder="Nb" value="1200" onchange="updateTWBufferLength(this);"/>
              <div id="life-span">
              </div>
            </td>
            <td align="center" valign="top" rowspan="6">
              <canvas id="twdEvolutionCanvas" height="500" width="400" class="displayCanvas"></canvas>
            </td>
            <td align="center" valign="top" rowspan="6">
              <canvas id="twsEvolutionCanvas" height="500" width="400" class="displayCanvas"></canvas>
            </td>
          </tr>
        </table>
      </p>
    </div>
		<div id="current-evolution" style="display: none;">
			<div style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; max-height: 80%; width: 160px; float: left;">
			  <table>
					<tr>
						<td valign="top">
							<div>
								<table align="center" cellspacing="10" border="0">
									<tr>
										<th></th>
									</tr>
									<tr>
										<td valign="top" align="right">
											<button onclick="resetCurrBuffer();" style="margin-bottom: 10px;">Reset All</button>
											<br>
											<button onclick="resetCurr2Buffer();" style="margin-bottom: 10px;">Drop Oldest Half</button>
											<br>
											Max&nbsp;nb&nbsp;pts:<input type="text" style="text-align: right;" size="6" placeholder="Nb" value="1200" onchange="updateCurrentBufferLength(this);"/>
											<br>
											<div id="life-span-current">
											</div>
											<div style="text-align: left;">
												<canvas id="currentDisplayCanvas2" height="140" width="140" title="Current, speed and direction"><!-- class="displayCanvas" --></canvas>
												<br/>
												<input type="radio" name="buffer-size-rb" onchange="" value="inst" checked /> Instant.
												<br/>
												<input type="radio" name="buffer-size-rb" onchange="" value="30s" /> 30 seconds.
												<br/>
												<input type="radio" name="buffer-size-rb" onchange="" value="1m" /> 1 minute.
												<br/>
												<input type="radio" name="buffer-size-rb" onchange="" value="10m" /> 10 minutes.
											</div>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
				</table>
			</div>
			<div style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; max-height: 80%; overflow-y: scroll; overflow-x: scroll;">
				<table align="center" cellspacing="10" border="0">
					<tr>
						<td>
							<div style="border-radius: 5px; border: 1px solid rgba(155, 255, 255, 0.5);">
							<table align="center" cellspacing="10" border="0">
								<tr>
									<th colspan="2">Instant triangulation</th>
								</tr>
								<tr>
									<td align="center" valign="top">
										<canvas id="currentDirEvolutionCanvas" height="500" width="200" class="displayCanvas"></canvas>
									</td>
									<td align="center" valign="top">
										<canvas id="currentSpeedEvolutionCanvas" height="500" width="200" class="displayCanvas"></canvas>
									</td>
								</tr>
							</table>
							</div>
						</td>
						<td>
							<div style="border-radius: 5px; border: 1px solid rgba(155, 255, 255, 0.5);">
								<table align="center" cellspacing="10" border="0">
									<tr>
										<th colspan="2">On 30 seconds</th>
									</tr>
									<tr>
										<td align="center" valign="top">
											<canvas id="currentDirEvolutionCanvas30s" height="500" width="200" class="displayCanvas"></canvas>
										</td>
										<td align="center" valign="top">
											<canvas id="currentSpeedEvolutionCanvas30s" height="500" width="200" class="displayCanvas"></canvas>
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td>
							<div style="border-radius: 5px; border: 1px solid rgba(155, 255, 255, 0.5);">
								<table align="center" cellspacing="10" border="0">
									<tr>
										<th colspan="2">On 1 minute</th>
									</tr>
									<tr>
										<td align="center" valign="top">
											<canvas id="currentDirEvolutionCanvas1m" height="500" width="200" class="displayCanvas"></canvas>
										</td>
										<td align="center" valign="top">
											<canvas id="currentSpeedEvolutionCanvas1m" height="500" width="200" class="displayCanvas"></canvas>
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td>
							<div style="border-radius: 5px; border: 1px solid rgba(155, 255, 255, 0.5);">
								<table align="center" cellspacing="10" border="0">
									<tr>
										<th colspan="2">On 10 minutes</th>
									</tr>
									<tr>
										<td align="center" valign="top">
											<canvas id="currentDirEvolutionCanvas10m" height="500" width="200" class="displayCanvas"></canvas>
										</td>
										<td align="center" valign="top">
											<canvas id="currentSpeedEvolutionCanvas10m" height="500" width="200" class="displayCanvas"></canvas>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
    <div id="err-mess"></div>
    <address><span id="console-type"></span></address>
  </body>
</html>
